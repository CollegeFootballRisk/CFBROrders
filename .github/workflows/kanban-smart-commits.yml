name: Kanban Smart Commits (Labels)

on:
  push:
    branches:
      - master

jobs:
  update-issue-labels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Update issue labels
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO: ${{ github.repository }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "Commit message: $COMMIT_MSG"

          # Extract issue number
          ISSUE=$(echo "$COMMIT_MSG" | grep -o "#[0-9]\+" | head -n1 | tr -d '#')
          if [ -z "$ISSUE" ]; then
            echo "No issue number found. Exiting."
            exit 0
          fi
          echo "Issue number: $ISSUE"

          # Determine label to add
          if echo "$COMMIT_MSG" | grep -q "#backlog"; then
            LABEL="Backlog"
            CLOSE="false"
          elif echo "$COMMIT_MSG" | grep -q "#in-progress"; then
            LABEL="In Progress"
            CLOSE="false"
          elif echo "$COMMIT_MSG" | grep -q "#review"; then
            LABEL="Review"
            CLOSE="false"
          elif echo "$COMMIT_MSG" | grep -q "#done"; then
            LABEL="Done"
            CLOSE="true"
          else
            LABEL=""
            CLOSE="false"
          fi
          echo "Label to add: $LABEL"

          # Remove old status labels
          STATUS_LABELS='Backlog In Progress Review Done'
          for l in $STATUS_LABELS; do
            curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/issues/$ISSUE/labels/$l
          done

          # Add new label
          if [ -n "$LABEL" ]; then
            curl -s -X POST -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/issues/$ISSUE/labels \
              -d "{\"labels\":[\"$LABEL\"]}"
            echo "Added label $LABEL to issue #$ISSUE"
          fi

          # Close the issue if #done
          if [ "$CLOSE" = "true" ]; then
            curl -s -X PATCH -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/$REPO/issues/$ISSUE \
              -d "{\"state\":\"closed\",\"body\":\"Automatically closed via commit: $COMMIT_MSG\"}"
            echo "Closed issue #$ISSUE"
          fi
